var e=(e,t,o)=>new Promise(((r,n)=>{var i=e=>{try{c(o.next(e))}catch(t){n(t)}},s=e=>{try{c(o.throw(e))}catch(t){n(t)}},c=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,s);c((o=o.apply(e,t)).next())}));import{g as t}from"./google-BCF_8OpS.js";const o="AIzaSyA0XN9LpLvaFKOEINnOOVYnfOQe59fZ0vs",r="936180176580-n0pqqqc7i8d6o654t96jau7p3p5jon4l.apps.googleusercontent.com",n="1PuRF7QqOICzAo-NGiJA56HOVAdS2pDIn",i=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];let s=!1,c=!1,l=!1,a=!1;"undefined"!=typeof window&&(window.cspErrors=window.cspErrors||[],window.googleCspBlocked=!1,window.addEventListener("securitypolicyviolation",(e=>{if(window.cspErrors.push({blockedURI:e.blockedURI,violatedDirective:e.violatedDirective,timestamp:Date.now()}),e.blockedURI&&(e.blockedURI.includes("google")||e.blockedURI.includes("gstatic")||e.blockedURI.includes("googleapis")||e.blockedURI.includes("accounts.google.com"))){l=!0,window.googleCspBlocked=!0,a=!0;try{localStorage.setItem("useLocalContent","true")}catch(t){}}})),setTimeout((()=>{const e=document.querySelectorAll('meta[http-equiv*="Content-Security"]');e.length>0&&e.forEach((e=>{const t=e.getAttribute("content")||"";if(t.includes("script-src")&&!t.includes("googleapis.com")){window.googleCspBlocked=!0,l=!0,a=!0;try{localStorage.setItem("useLocalContent","true")}catch(o){}}}))}),1e3));const d=()=>s?Promise.resolve():(()=>{try{return!("undefined"==typeof window||!window.location.search.includes("localContent=true"))||"undefined"!=typeof window&&"true"===localStorage.getItem("useLocalContent")||!!("undefined"!=typeof window&&window.cspErrors&&window.cspErrors.length>0)||!("undefined"==typeof window||!window.googleCspBlocked)}catch(e){return!1}})()?(l=!0,a=!0,s=!0,Promise.reject(new Error("CSP_ERROR"))):new Promise(((e,n)=>{const d=setTimeout((()=>{s=!0,a=!0,n(new Error("TIMEOUT"))}),8e3);try{t.load("client:auth2",(()=>{clearTimeout(d),t.client.init({apiKey:o,clientId:r,discoveryDocs:i,scope:"https://www.googleapis.com/auth/drive.file"}).then((()=>{t.auth2.getAuthInstance().isSignedIn.get()||c||(c=!0),s=!0,e()})).catch((e=>{if(e.details&&(e.details.includes("Content Security Policy")||e.details.includes("blocked by CSP"))){l=!0,a=!0;try{localStorage.setItem("useLocalContent","true")}catch(t){}}else 0;s=!0,n(e)}))}),(e=>{clearTimeout(d),s=!0,a=!0,n(e)}))}catch(u){clearTimeout(d),s=!0,a=!0,n(u)}})),u=()=>e(null,null,(function*(){if(l||window.googleCspBlocked)return Promise.reject(new Error("CSP_ERROR"));try{t.auth2||(yield d());return yield t.auth2.getAuthInstance().signIn({prompt:"select_account"})}catch(e){throw"popup_closed_by_user"===e.error||("idpiframe_initialization_failed"===e.error||e.message&&(e.message.includes("CSP")||e.message.includes("Content Security Policy")))&&(l=!0,window.googleCspBlocked=!0),e}})),p=()=>e(null,null,(function*(){if(l)return!1;try{return t.auth2||(yield d()),t.auth2.getAuthInstance().isSignedIn.get()}catch(e){return!1}})),w=()=>e(null,null,(function*(){const e=Date.now(),t=`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://drive.google.com/uc?id=${n}&export=download`)}&_=${e}`;try{const e=yield fetch(t,{method:"GET",cache:"no-cache"});if(!e.ok)throw new Error(`CORS proxy fetch failed with status ${e.status}`);const r=yield e.text();if(!r||0===r.trim().length)throw new Error("CORS proxy returned empty content");if(r.trim().startsWith("<")||r.includes("<!DOCTYPE"))throw new Error("CORS proxy returned HTML instead of JSON");try{const e=JSON.parse(r);if(e.error)throw new Error("Google Drive returned error: "+e.error);if(!e||"object"!=typeof e||0===Object.keys(e).length)throw new Error("CORS proxy returned invalid content structure");return e}catch(o){throw new Error("Failed to parse JSON from CORS proxy: "+o.message)}}catch(r){throw new Error("CORS proxy fetch failed: "+r.message)}})),h=(o,r="content.json")=>e(null,null,(function*(){try{if(!(t.client&&t.client.drive||(yield d(),t.client&&t.client.drive)))throw new Error("Google Drive client could not be initialized.");const e=t.auth2.getAuthInstance();if(e.isSignedIn.get()||(yield u()),!e.isSignedIn.get())throw new Error("User not signed in after attempting to sign in.");const i=JSON.stringify(o,null,2);if(!o||0===Object.keys(o).length||"{}"===i||i.length<10)throw new Error("Attempted to save empty or invalid content. Please check the data source.");if(o.error)throw new Error("Attempted to save error response as content. Please check the data source.");const s="-------314159265358979323846",c="\r\n--"+s+"\r\n",l="\r\n--"+s+"--",a={name:r,mimeType:"application/json"},p=c+"Content-Type: application/json\r\n\r\n"+JSON.stringify(a)+c+"Content-Type: application/json\r\n\r\n"+i+l,w=t.client.request({path:`https://www.googleapis.com/upload/drive/v3/files/${n}`,method:"PATCH",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/related; boundary="'+s+'"'},body:p}),h=(yield w).result;if(!h||!h.id)throw new Error("Failed to update existing file on Google Drive.");return h}catch(e){if(e.result&&e.result.error&&404===e.result.error.code)try{const e="-------314159265358979323846",o="\r\n--"+e+"\r\n",n="\r\n--"+e+"--",i={name:r,mimeType:"application/json"},s=o+"Content-Type: application/json\r\n\r\n"+JSON.stringify(i)+o+"Content-Type: application/json\r\n\r\n"+stringifiedContent+n,c=t.client.request({path:"https://www.googleapis.com/upload/drive/v3/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/related; boundary="'+e+'"'},body:s}),l=(yield c).result;if(l)return l}catch(i){}if(e.result&&e.result.error){const t=new Error(e.result.error.message||`Drive API operation failed. Status: ${e.status||"unknown"}`);throw t.details=e.result.error,t}if("Attempted to save empty or invalid content. Please check the data source."===e.message)throw e;throw e}}));export{w as fetchContentFromDrive,d as initDriveClient,p as isSignedInToGoogle,h as saveAndReplaceDriveFile,u as signInToGoogle};
