var e=(e,t,o)=>new Promise(((n,r)=>{var i=e=>{try{c(o.next(e))}catch(t){r(t)}},l=e=>{try{c(o.throw(e))}catch(t){r(t)}},c=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,l);c((o=o.apply(e,t)).next())}));import{g as t}from"./google-BCF_8OpS.js";import{l as o}from"./index-AU1zVNU6.js";import"./ui-DTrmruK9.js";import"./vendor-CMmhtoO5.js";import"./utils-ZfQrkrhd.js";import"./themes-pFQOMWgW.js";import"./forms-CiwEs6bv.js";import"./router-C9c491zF.js";const n="AIzaSyA0XN9LpLvaFKOEINnOOVYnfOQe59fZ0vs",r="936180176580-n0pqqqc7i8d6o654t96jau7p3p5jon4l.apps.googleusercontent.com",i="1PuRF7QqOICzAo-NGiJA56HOVAdS2pDIn",l=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];let c=!1,s=!1,a=!1,d=!1;const u=()=>{try{return!("undefined"==typeof window||!window.location.search.includes("localContent=true"))||("undefined"!=typeof window&&"true"===localStorage.getItem("useLocalContent")||(!!("undefined"!=typeof window&&window.cspErrors&&window.cspErrors.length>0)||!("undefined"==typeof window||!window.googleCspBlocked)))}catch(e){return!1}};"undefined"!=typeof window&&(window.cspErrors=window.cspErrors||[],window.googleCspBlocked=!1,window.addEventListener("securitypolicyviolation",(e=>{if(window.cspErrors.push({blockedURI:e.blockedURI,violatedDirective:e.violatedDirective,timestamp:Date.now()}),e.blockedURI&&(e.blockedURI.includes("google")||e.blockedURI.includes("gstatic")||e.blockedURI.includes("googleapis")||e.blockedURI.includes("accounts.google.com"))){a=!0,window.googleCspBlocked=!0,d=!0;try{localStorage.setItem("useLocalContent","true")}catch(t){}}})),setTimeout((()=>{const e=document.querySelectorAll('meta[http-equiv*="Content-Security"]');e.length>0&&e.forEach((e=>{const t=e.getAttribute("content")||"";if(t.includes("script-src")&&!t.includes("googleapis.com")){window.googleCspBlocked=!0,a=!0,d=!0;try{localStorage.setItem("useLocalContent","true")}catch(o){}}}))}),1e3));const w=()=>c?Promise.resolve():u()?(a=!0,d=!0,c=!0,Promise.reject(new Error("CSP_ERROR"))):new Promise(((e,o)=>{const i=setTimeout((()=>{c=!0,d=!0,o(new Error("TIMEOUT"))}),8e3);try{t.load("client:auth2",(()=>{clearTimeout(i),t.client.init({apiKey:n,clientId:r,discoveryDocs:l,scope:"https://www.googleapis.com/auth/drive.file"}).then((()=>{t.auth2.getAuthInstance().isSignedIn.get()||s||(s=!0),c=!0,e()})).catch((e=>{if(e.details&&(e.details.includes("Content Security Policy")||e.details.includes("blocked by CSP"))){a=!0,d=!0;try{localStorage.setItem("useLocalContent","true")}catch(t){}}c=!0,o(e)}))}),(e=>{clearTimeout(i),c=!0,d=!0,o(e)}))}catch(u){clearTimeout(i),c=!0,d=!0,o(u)}})),p=()=>e(null,null,(function*(){if(a||window.googleCspBlocked)return o(),Promise.reject(new Error("CSP_ERROR"));try{t.auth2||(yield w());return yield t.auth2.getAuthInstance().signIn({prompt:"select_account"})}catch(e){throw"popup_closed_by_user"===e.error||("idpiframe_initialization_failed"===e.error||e.message&&(e.message.includes("CSP")||e.message.includes("Content Security Policy")))&&(a=!0,window.googleCspBlocked=!0,o()),e}})),g=()=>e(null,null,(function*(){if(a)return!1;try{return t.auth2||(yield w()),t.auth2.getAuthInstance().isSignedIn.get()}catch(e){return!1}})),h=()=>e(null,null,(function*(){if(u())throw new Error("Google Drive access blocked by Content Security Policy");try{t.client&&t.client.drive||(yield w())}catch(e){throw new Error("Google Drive client initialization failed")}if(!("undefined"!=typeof window&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||""===window.location.hostname))){try{if(t.client&&t.client.drive&&t.auth2){const e=t.auth2.getAuthInstance();if(e&&e.isSignedIn.get())return yield y()}}catch(e){}return yield m()}try{if(t.client&&t.client.drive&&t.auth2){const e=t.auth2.getAuthInstance();if(e&&e.isSignedIn.get())return yield y();throw new Error("Not signed in to Google Drive - Please sign in to access content")}throw new Error("Google Drive client not initialized")}catch(e){throw e}})),y=()=>e(null,null,(function*(){try{const o=S();if(!o)throw new Error("No Drive File ID configured");const n=yield t.client.drive.files.get({fileId:o,alt:"media"});if(!n.body)throw new Error("No body in response");try{const e=JSON.parse(n.body);if(e.error)throw new Error(`Google API Error: ${e.error.message||"Unknown error"}`);return e}catch(e){throw new Error("Failed to parse Drive content as JSON")}}catch(o){throw o}})),m=()=>e(null,null,(function*(){try{const e=S();if(!e)throw new Error("No Drive File ID configured");const t=`https://www.googleapis.com/drive/v3/files/${e}?alt=media&key=${n}`,o=yield fetch(t,{method:"GET",mode:"cors",headers:{Accept:"application/json"}});if(!o.ok)throw new Error(`HTTP ${o.status}: ${o.statusText}`);const r=yield o.text();return JSON.parse(r)}catch(e){throw e}})),f=(o,n="content.json")=>e(null,null,(function*(){try{if(!(t.client&&t.client.drive||(yield w(),t.client&&t.client.drive)))throw new Error("Google Drive client could not be initialized.");const e=t.auth2.getAuthInstance();if(e.isSignedIn.get()||(yield p()),!e.isSignedIn.get())throw new Error("User not signed in after attempting to sign in.");const r=JSON.stringify(o,null,2);if(!o||0===Object.keys(o).length||"{}"===r||r.length<10)throw new Error("Attempted to save empty or invalid content. Please check the data source.");if(o.error)throw new Error("Attempted to save error response as content. Please check the data source.");const i=S();if(!i)throw new Error("No file ID available to update. Please check the configuration.");const l="-------314159265358979323846",c="\r\n--"+l+"\r\n",s="\r\n--"+l+"--",a={name:n,mimeType:"application/json"},d=c+"Content-Type: application/json\r\n\r\n"+JSON.stringify(a)+c+"Content-Type: application/json\r\n\r\n"+r+s,u=t.client.request({path:`https://www.googleapis.com/upload/drive/v3/files/${i}`,method:"PATCH",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/related; boundary="'+l+'"'},body:d}),g=(yield u).result;if(!g||!g.id)throw new Error("Failed to update existing file on Google Drive.");return g}catch(e){if(e.result&&e.result.error&&404===e.result.error.code)try{const e="-------314159265358979323846",o="\r\n--"+e+"\r\n",r="\r\n--"+e+"--",i={name:n,mimeType:"application/json"},l=o+"Content-Type: application/json\r\n\r\n"+JSON.stringify(i)+o+"Content-Type: application/json\r\n\r\n"+stringifiedContent+r,c=t.client.request({path:"https://www.googleapis.com/upload/drive/v3/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/related; boundary="'+e+'"'},body:l}),s=(yield c).result;if(s&&s.id)return C(s.id),s}catch(r){}if(e.result&&e.result.error){const t=new Error(e.result.error.message||`Drive API operation failed. Status: ${e.status||"unknown"}`);throw t.details=e.result.error,t}if("Attempted to save empty or invalid content. Please check the data source."===e.message)throw e;throw e}})),v=e=>{d=e;try{e?localStorage.setItem("useLocalContent","true"):(localStorage.removeItem("useLocalContent"),a=!1,d=!1,c=!1,s=!1,"undefined"!=typeof window&&(window.googleCspBlocked=!1,window.cspErrors=[]))}catch(t){}return d},I=()=>{c=!1,s=!1,a=!1,d=!1,"undefined"!=typeof window&&(window.googleCspBlocked=!1,window.cspErrors&&(window.cspErrors=[]),localStorage.removeItem("useLocalContent"),localStorage.removeItem("dynamicDriveFileId")),E=i};let E=i;const S=()=>{if("undefined"!=typeof window){const e=localStorage.getItem("dynamicDriveFileId");if(e)return E=e,e}return E},C=e=>{E=e,"undefined"!=typeof window&&localStorage.setItem("dynamicDriveFileId",e)};export{h as fetchContentFromDrive,S as getCurrentDriveFileId,w as initDriveClient,g as isSignedInToGoogle,I as resetContentState,f as saveAndReplaceDriveFile,p as signInToGoogle,v as toggleLocalContentMode};
